file:
  # Main Apache config file includes other config files
  {{ .Vars.root_dir }}/apache/conf/httpd.conf:
    exists: true
    filetype: file
    contains:
      - /^Include.*{{ .Vars.root_dir }}/apache/conf/pacloud/pacloud.conf/
      - /^Include.*{{ .Vars.root_dir }}/apache/conf/vhosts/\*.conf/
      - /^Include.*{{ .Vars.root_dir }}/apache/conf/deflate.conf/
  # Main Pacloud config file was correctly generated
  {{ .Vars.root_dir }}/apache/conf/pacloud/pacloud.conf:
    exists: true
    filetype: file
    contains:
      - /DocumentRoot.*{{ .Vars.root_dir }}/apache/htdocs/
      - /^Include.*{{ .Vars.root_dir }}/apache/conf/pacloud/pacloud-ssl.conf/
  # Main Pacloud ssl config file was correctly generated
  {{ .Vars.root_dir }}/apache/conf/pacloud/pacloud-ssl.conf:
    exists: true
    filetype: file
    contains:
      - "SSLProtocol all -SSLv2 -SSLv3"
      - /SSLCertificateFile.*pacloud/certs/server.crt/
      - /SSLCertificateKeyFile.*pacloud/certs/server.key/
  # CGI folder has been removed, as recommended by Apache
  {{ .Vars.root_dir }}/apache/cgi-bin:
    exists: false
  # Compiled disabled modules should have been generated
  {{ range $module := .Vars.modules.extra }}
  {{ $.Vars.root_dir }}/apache/modules/mod_{{ $module }}.so:
    exists: true
    filetype: file
  {{ end }}
command:
  # There are no syntax error in the configuration
  check-configuration:
    exec: apachectl -t
    exit-status: 0
  # Check explicitly enabled and disabled modules
  check-loaded-modules:
    exec: apachectl -M
    exit-status: 0
    stdout:
    {{ range $module := .Vars.modules.loaded }}
      - "{{ $module }}_module"
    {{ end }}
    {{ range $module := .Vars.modules.disabled }}
      - "!{{ $module }}_module"
    {{ end }}
